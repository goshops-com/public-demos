<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gopersonal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="script.js"></script>
    <script>
      async function initializeGSSDK() {
        window.gsSDK = await new window.GSSDK.default("BR-ZwkdOLze01CgSUtr", {
          provider: "Fenicio",
        });
        await loadFuseAutocomplete();
      }
      var gsSDKScript = document.createElement("script");
      gsSDKScript.src = "https://sdk.gopersonal.ai/gs-sdk.js";
      gsSDKScript.onload = initializeGSSDK;
      document.head.appendChild(gsSDKScript);
    </script>
    <style>
      .search-overlay {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }
      .search-header {
        flex-shrink: 0;
      }
      #results {
        min-height: 100%;
        padding-bottom: 70px; /* Space for chat input */
      }
      .search-content {
        flex-grow: 1;
        overflow-y: auto;
        padding-bottom: 70px;
      }
      .search-icon {
        width: 24px;
        height: 24px;
        filter: brightness(0) invert(1); /* This will make the icons white */
        transition: filter 0.3s ease;
      }
      .search-icon:hover {
        filter: brightness(0) invert(0.8) sepia(1) saturate(5)
          hue-rotate(180deg); /* This will make the icons light blue on hover */
      }
      .search-input-container {
        position: relative;
        width: 100%;
      }

      .autocomplete-items {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        background-color: rgba(26, 32, 44, 0.95); /* Dark background color */
        border: 1px solid #4a5568; /* Dark border color */
        border-top: none;
        max-height: 300px;
        overflow-y: auto;
      }

      .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        color: #e2e8f0; /* Light text color */
        border-bottom: 1px solid #4a5568;
      }

      .autocomplete-items div:hover {
        background-color: #2d3748; /* Darker background on hover */
      }

      .autocomplete-active {
        background-color: #4299e1 !important; /* Blue background for active item */
        color: white !important;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      .chat-section {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .chat-header {
        display: none;
      }

      .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
      }

      .follow-up-container {
        flex-shrink: 0;
      }

      @media (max-width: 768px) {
        #chatSection {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          z-index: 40;
          height: auto;
          background-color: transparent;
        }

        #chatSection.active {
          background-color: rgba(26, 32, 44, 0.95);
          max-height: 50vh;
          overflow-y: auto;
          /* padding-top: 2rem; */
        }

        #chatMessages {
          display: none;
        }

        #chatSection.active #chatMessages {
          display: block;
          max-height: calc(50vh - 80px);
          overflow-y: auto;
        }

        .follow-up-container {
          background-color: rgba(26, 32, 44, 0.95);
          padding: 0.5rem 1rem;
        }

        .chat-header {
          display: none;
        }

        #chatSection.active .chat-header {
          display: block;
          position: absolute;
          top: 0;
          right: 0;
          padding: 0.5rem;
        }

        .chat-close-btn {
          background-color: rgba(255, 255, 255, 0.2);
          color: white;
          border: none;
          border-radius: 50%;
          width: 30px;
          height: 30px;
          font-size: 1.2rem;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: background-color 0.3s ease;
        }

        .chat-close-btn:hover {
          background-color: rgba(255, 255, 255, 0.3);
        }
      }

      .filter-category {
        border-bottom: 1px solid #4a5568;
        padding-bottom: 1rem;
        margin-bottom: 1rem;
      }
      .filter-category:last-child {
        border-bottom: none;
      }
      .filter-category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }
      .filter-category-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }
      .filter-category-content.expanded {
        max-height: 500px;
        transition: max-height 0.5s ease-in;
      }
      .chevron {
        transition: transform 0.3s ease;
      }
      .chevron.rotated {
        transform: rotate(180deg);
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <button id="searchBtn" class="m-4 p-2 bg-gray-200 text-gray-700 rounded">
      Buscar
    </button>

    <div
      id="searchOverlay"
      class="fixed inset-0 bg-black bg-opacity-92 z-50 hidden search-overlay"
    >
      <div class="container mx-auto p-4 search-header">
        <div class="flex justify-between items-center mb-4">
          <!-- here brand name can go -->
          <div class="text-white text-2xl"></div>
          <!-- here brand name can go -->
          <button id="closeBtn" class="text-white">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div class="flex items-center border-b border-white mb-4">
          <div class="search-input-container w-full relative">
            <input
              type="text"
              id="searchInput"
              placeholder="top"
              class="w-full p-2 bg-transparent text-white text-4xl focus:outline-none"
            />
            <div id="autocomplete-list" class="autocomplete-items w-full"></div>
          </div>
          <div class="flex items-center">
            <button id="searchIcon" class="p-2">
              <img
                src="https://public-assets.goshops.ai/search.svg"
                alt="Search"
                class="search-icon"
              />
            </button>
            <button id="micIcon" class="p-2">
              <img
                src="https://public-assets.goshops.ai/mic.svg"
                alt="Microphone"
                class="search-icon"
              />
            </button>
            <button id="uploadIcon" class="p-2">
              <img
                src="https://public-assets.goshops.ai/upload.svg"
                alt="Upload"
                class="search-icon"
              />
            </button>
          </div>
        </div>
        <div class="flex justify-between items-center mb-4">
          <div id="filterDisplay" class="text-white hidden">
            <span id="filterText" class="bg-gray-700 px-2 py-1 rounded"></span>
            <button id="removeFilter" class="ml-2 text-red-500">×</button>
          </div>
          <button id="filterBtn" class="text-white flex items-center">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-2"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z"
                clip-rule="evenodd"
              />
            </svg>
            Filter
          </button>
        </div>
      </div>
      <div id="loadingIndicator" class="text-white text-center py-4 hidden">
        Cargando...
      </div>

      <div class="search-content container mx-auto px-4">
        <div class="flex flex-col md:flex-row h-full">
          <div
            id="results"
            class="w-full md:w-4/5 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 overflow-y-auto pr-4"
          ></div>

          <div id="chatSection" class="chat-section w-full md:w-1/5 md:ml-4">
            <div class="chat-header">
              <div class="chat-drag-indicator"></div>
              <button class="chat-close-btn">&times;</button>
            </div>
            <div
              id="chatMessages"
              class="chat-messages bg-gray-800 text-white p-4 rounded-lg mb-4"
            ></div>
            <div class="follow-up-container">
              <div class="relative">
                <input
                  type="text"
                  id="followUpInput"
                  placeholder="Ask a follow-up question"
                  class="w-full p-2 pr-10 bg-gray-700 text-white rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <button
                  id="sendFollowUp"
                  class="absolute right-2 top-1/2 transform -translate-y-1/2 text-white"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-6 w-6"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="filterModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[60]"
    >
      <div
        class="bg-gray-800 rounded-lg w-[90vw] max-w-4xl h-[90vh] flex flex-col text-white relative"
      >
        <button
          id="closeFilterBtn"
          class="absolute top-4 right-4 text-gray-400 hover:text-white"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
        <div class="p-6 flex-shrink-0">
          <h3 class="text-2xl font-semibold mb-4">Add Filter</h3>
          <input
            type="text"
            id="filterInput"
            placeholder="Write your filter here"
            class="w-full p-2 bg-gray-700 border border-gray-600 rounded mb-4 text-white placeholder-gray-400"
          />
        </div>
        <div class="px-6 pb-6 overflow-y-auto flex-grow">
          <div id="filterOptions" class="space-y-4">
            <!-- Dynamically generated filter options will go here -->
          </div>
        </div>
        <div
          class="p-4 border-t border-gray-700 flex justify-end flex-shrink-0"
        >
          <button
            id="cancelFilterBtn"
            class="px-4 py-2 text-gray-300 mr-2 hover:text-white"
          >
            Cancel
          </button>
          <button
            id="confirmFilterBtn"
            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
          >
            Confirm
          </button>
        </div>
      </div>
    </div>

    <script>
      // Filter categories
      async function getDynamicFacets() {
        const waitForSDK = async (timeout = 5000) => {
          const start = Date.now();
          while (!window.gsSDK) {
            if (Date.now() - start > timeout) {
              throw new Error("SDK initialization timeout");
            }
            await new Promise((resolve) => setTimeout(resolve, 10));
          }
        };

        try {
          await waitForSDK();

          const searchInput = document.getElementById("searchInput");
          const searchTerm = searchInput.value.trim();
          let query = undefined;
          if (searchTerm != "") {
            query = searchTerm;
          }

          const facelets = await window.gsSDK.searchFilterFacelets(query);
          window.gsFacelets = facelets;
          if (window.gsFacelets && window.gsFacelets.facetDistribution) {
            return window.gsFacelets.facetDistribution;
          }
        } catch (error) {
          console.error("Error in getDynamicFacets:", error);
        }
        return {};
      }
      function getFacetLabels() {
        if (window.gsFacelets && window.gsFacelets.facetMappin) {
          return window.gsFacelets.facetMappin;
        }
        return {}; // Return an empty object if labels are not available
      }

      let currentFilter = null;
      let debounceTimer;

      document.addEventListener("DOMContentLoaded", () => {
        // Element selections
        const searchBtn = document.getElementById("searchBtn");
        const closeBtn = document.getElementById("closeBtn");
        const searchOverlay = document.getElementById("searchOverlay");
        const searchInput = document.getElementById("searchInput");
        const autocompleteList = document.getElementById("autocomplete-list");
        const filterBtn = document.getElementById("filterBtn");
        const filterModal = document.getElementById("filterModal");
        const filterInput = document.getElementById("filterInput");
        const filterOptions = document.getElementById("filterOptions");
        const categoryOptions = document.getElementById("categoryOptions");
        const brandOptions = document.getElementById("brandOptions");
        const colorOptions = document.getElementById("colorOptions");
        const cancelFilterBtn = document.getElementById("cancelFilterBtn");
        const confirmFilterBtn = document.getElementById("confirmFilterBtn");
        const closeFilterBtn = document.getElementById("closeFilterBtn");
        const removeFilter = document.getElementById("removeFilter");
        const filterDisplay = document.getElementById("filterDisplay");
        const filterText = document.getElementById("filterText");
        const results = document.getElementById("results");
        const chatMessages = document.getElementById("chatMessages");
        const loadingIndicator = document.getElementById("loadingIndicator");
        const followUpInput = document.getElementById("followUpInput");
        const sendFollowUp = document.getElementById("sendFollowUp");
        const searchIcon = document.getElementById("searchIcon");
        const micIcon = document.getElementById("micIcon");
        const uploadIcon = document.getElementById("uploadIcon");
        const followUpBtn = document.getElementById("followUpBtn");
        const followUpInputContainer = document.getElementById(
          "followUpInputContainer"
        );

        const chatCloseBtn = document.querySelector(".chat-close-btn");
        chatCloseBtn.addEventListener("click", hideChatPanel);

        followUpInput.addEventListener("focus", showChatPanel);

        hideChatPanel();
        hideFollowUpContainer();
        // Event listeners

        function closeChatPanel() {
          const chatSection = document.getElementById("chatSection");
          chatSection.classList.remove("active");
          chatSection.classList.add("inactive");
        }

        searchBtn.addEventListener("click", () => {
          searchOverlay.classList.remove("hidden");
          searchInput.focus();
        });

        closeBtn.addEventListener("click", () => {
          searchOverlay.classList.add("hidden");
        });

        searchInput.addEventListener("input", (e) => {
          const val = e.target.value.trim();
          if (val.length > 0) {
            showAutocomplete(val);
          } else {
            hideAutocomplete();
          }
        });

        searchInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            hideAutocomplete();
            searchProducts();
          }
        });

        searchIcon.addEventListener("click", () => {
          hideAutocomplete();
          searchProducts();
        });

        micIcon.addEventListener("click", () => {
          console.log("Voice search clicked");
        });

        uploadIcon.addEventListener("click", () => {
          console.log("Image upload clicked");
        });

        filterBtn.addEventListener("click", openFilterModal);
        cancelFilterBtn.addEventListener("click", closeFilterModal);
        closeFilterBtn.addEventListener("click", closeFilterModal);
        let autoFilterDebounce;
        filterInput.addEventListener("input", () => {
          clearTimeout(autoFilterDebounce);
          autoFilterDebounce = setTimeout(autoFilter, 500);
        });

        confirmFilterBtn.addEventListener("click", async () => {
          const selectedFilters = {};
          const dynamicFacets = window.gsFacelets.facetDistribution;

          const facetLabels = window.gsFacelets.facetMappin;

          Object.keys(dynamicFacets).forEach((facetName) => {
            const facetOptions = document.querySelectorAll(
              `#${facetName}Options input:checked`
            );
            if (facetOptions.length > 0) {
              selectedFilters[facetName] = Array.from(facetOptions).map(
                (input) => ({
                  value: input.value,
                  label: input.dataset.label,
                })
              );
            }
          });

          const minPrice = document.querySelector(
            '#priceOptions input[placeholder="Min"]'
          ).value;
          const maxPrice = document.querySelector(
            '#priceOptions input[placeholder="Max"]'
          ).value;
          if (minPrice || maxPrice) {
            selectedFilters.price = { min: minPrice, max: maxPrice };
          }

          if (Object.keys(selectedFilters).length > 0) {
            currentFilter = selectedFilters;
            console.log("currentFilter", currentFilter);
            updateFilterDisplay();
            closeFilterModal();
            searchProducts();
          } else {
            closeFilterModal();
          }
        });

        async function autoFilter() {
          const filterInput = document.getElementById("filterInput");
          const inputValue = filterInput.value.toLowerCase();
          const filters = window.gsFacelets.facetDistribution;

          if (inputValue.length > 0) {
            showLoading();
            const updatedFilters = await window.gsSDK.searchAutoFilter(
              filters,
              inputValue
            );
            hideLoading();

            if (
              updatedFilters &&
              updatedFilters.filter &&
              updatedFilters.filter.filters &&
              updatedFilters.filter.filters.length > 0
            ) {
              let newFilter = {};
              updatedFilters.filter.filters.forEach((filter) => {
                if (filter.name.toLowerCase() === "price_max") {
                  if (!newFilter.price) {
                    newFilter.price = {};
                  }
                  newFilter.price.max = filter.values[0];
                } else if (filter.name.toLowerCase() === "price_min") {
                  if (!newFilter.price) {
                    newFilter.price = {};
                  }
                  newFilter.price.min = filter.values[0];
                } else {
                  newFilter[filter.name.toLowerCase()] = filter.values.map(
                    (value) => ({ label: value, value: value })
                  );
                }
              });

              console.log(
                "newFilter",
                "from API",
                updatedFilters.filter.filters,
                JSON.stringify(newFilter)
              );
              currentFilter = newFilter;
              updateFilterDisplay();
              updateFilterCheckboxes(); // Add this line to update checkboxes
            }
          }
        }

        function updateFilterDisplay() {
          const filterDisplay = document.getElementById("filterDisplay");
          const filterText = document.getElementById("filterText");
          const facetLabels = getFacetLabels();

          console.log("currentFilter", currentFilter);
          if (currentFilter && Object.keys(currentFilter).length > 0) {
            const filterString = Object.entries(currentFilter)
              .map(([facet, values]) => {
                const facetLabel = facetLabels[facet] || facet;
                if (facet === "price") {
                  return `${facetLabel}: ${values.min || "0"} - ${
                    values.max || "∞"
                  }`;
                }
                return `${facetLabel}: ${values
                  .map((v) => v.label)
                  .join(", ")}`;
              })
              .join("; ");

            filterText.textContent = filterString;
            filterDisplay.classList.remove("hidden");
          } else {
            filterDisplay.classList.add("hidden");
          }
        }

        function updateFilterCheckboxes() {
          if (!currentFilter) return;

          Object.entries(currentFilter).forEach(
            ([facetName, selectedValues]) => {
              if (facetName === "price") return; // Skip price, we'll handle it separately
              const facetContainer = document.getElementById(
                `${facetName}Options`
              );
              if (!facetContainer) return;

              const checkboxes = facetContainer.querySelectorAll(
                'input[type="checkbox"]'
              );
              checkboxes.forEach((checkbox) => {
                const isChecked = selectedValues.some(
                  (val) =>
                    val.value === checkbox.value ||
                    val.label === checkbox.dataset.label
                );
                checkbox.checked = isChecked;
              });
            }
          );

          // Handle price range inputs
          const priceOptions = currentFilter.price;
          const minPriceInput = document.querySelector(
            '#priceOptions input[placeholder="Min"]'
          );
          const maxPriceInput = document.querySelector(
            '#priceOptions input[placeholder="Max"]'
          );
          if (priceOptions) {
            if (minPriceInput) minPriceInput.value = priceOptions.min || "";
            if (maxPriceInput) maxPriceInput.value = priceOptions.max || "";
          } else {
            if (minPriceInput) minPriceInput.value = "";
            if (maxPriceInput) maxPriceInput.value = "";
          }

          // Expand all filter categories that have selected values
          const filterCategories =
            document.querySelectorAll(".filter-category");
          filterCategories.forEach((category) => {
            const content = category.querySelector(".filter-category-content");
            const chevron = category.querySelector(".chevron");

            // Check if it's the price category
            const isPriceCategory = category.querySelector("#priceOptions");
            let shouldExpand = false;

            if (isPriceCategory) {
              // For price category, check if min or max is set in currentFilter.price
              shouldExpand =
                priceOptions && (priceOptions.min || priceOptions.max);
            } else {
              // For other categories, check if any checkbox is checked
              shouldExpand = category.querySelector("input:checked") !== null;
            }

            if (shouldExpand) {
              content.classList.add("expanded");
              chevron.classList.add("rotated");
            } else {
              content.classList.remove("expanded");
              chevron.classList.remove("rotated");
            }
          });
        }

        removeFilter.addEventListener("click", () => {
          currentFilter = null;
          updateFilterDisplay();
          searchProducts();
        });

        sendFollowUp.addEventListener("click", () => {
          handleFollowUp();
        });

        followUpInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            handleFollowUp();
          }
        });

        // Initial population of filter options
        updateFilterOptions();
      });

      function hideChatPanel() {
        const chatSection = document.getElementById("chatSection");
        chatSection.classList.remove("active");
        hideChatMessages();
      }

      function showChatPanel() {
        const chatSection = document.getElementById("chatSection");
        chatSection.classList.add("active");
      }

      let isLoading = false;

      function showLoading() {
        if (isLoading) return; // Prevent multiple overlays
        isLoading = true;

        const loadingOverlay = document.createElement("div");
        loadingOverlay.id = "simpleMagicalLoadingOverlay";
        loadingOverlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  `;

        const magicalLoader = document.createElement("div");
        magicalLoader.className = "simple-magical-loader";

        loadingOverlay.appendChild(magicalLoader);
        document.body.appendChild(loadingOverlay);

        // Add the keyframe animations and styles
        const style = document.createElement("style");
        style.textContent = `
    .simple-magical-loader {
      width: 50px;
      height: 50px;
      background-color: #4a9ff5;
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
      animation: simple-magical-pulse 1.5s infinite ease-in-out;
    }
    @keyframes simple-magical-pulse {
      0%, 100% { transform: scale(0.8); opacity: 0.5; }
      50% { transform: scale(1.2); opacity: 1; }
    }
  `;
        document.head.appendChild(style);
      }

      function hideLoading() {
        if (!isLoading) return;
        isLoading = false;

        const loadingOverlay = document.getElementById(
          "simpleMagicalLoadingOverlay"
        );
        if (loadingOverlay) {
          loadingOverlay.remove();
        }
      }

      function hideChatMessages() {
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.style.display = "none";
      }

      function showChatMessages() {
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.style.display = "block";
        showChatPanel();
      }

      function hideFollowUpContainer() {
        const followUpContainer = document.querySelector(
          ".follow-up-container"
        );
        if (followUpContainer) {
          followUpContainer.classList.add("hidden");
        }
      }

      function showFollowUpContainer() {
        const followUpContainer = document.querySelector(
          ".follow-up-container"
        );
        if (followUpContainer) {
          followUpContainer.classList.remove("hidden");
        }
      }

      function toggleFollowUpInput() {
        const followUpContainer = document.querySelector(
          ".follow-up-container"
        );
        followUpContainer.classList.toggle("hidden");
      }

      async function showAutocomplete(val) {
        const autocompleteList = document.getElementById("autocomplete-list");
        autocompleteList.innerHTML = "";
        autocompleteList.style.display = "block";

        const matchingItems = await window.gsPerformSearch(
          val.toLowerCase(),
          5
        );
        console.log("resultAutoComplete", matchingItems);

        matchingItems.forEach((item) => {
          const div = document.createElement("DIV");
          const name = item.item.name;
          const matches = item.matches[0];

          let highlightedName = "";
          let lastIndex = 0;

          matches.indices.forEach(([start, end]) => {
            highlightedName += name.substring(lastIndex, start);
            highlightedName +=
              "<strong>" + name.substring(start, end + 1) + "</strong>";
            lastIndex = end + 1;
          });

          highlightedName += name.substring(lastIndex);

          div.innerHTML = highlightedName;
          div.innerHTML += "<input type='hidden' value='" + name + "'>";

          div.addEventListener("click", function (e) {
            document.getElementById("searchInput").value =
              this.getElementsByTagName("input")[0].value;
            hideAutocomplete();
            searchProducts();
          });

          autocompleteList.appendChild(div);
        });
      }

      function hideAutocomplete() {
        const autocompleteList = document.getElementById("autocomplete-list");
        autocompleteList.style.display = "none";
      }

      function populateOptions(container, facetName, options, labels) {
        container.innerHTML = Object.entries(options)
          .map(([option, count]) => {
            const label = labels[option] || option; // Use the label if available, otherwise use the option itself
            return `
            <label class="block">
              <input type="checkbox" value="${option}" data-label="${label}" class="mr-2">
              ${label} (${count})
            </label>
          `;
          })
          .join("");
      }

      async function updateFilterOptions() {
        const inputValue = document
          .getElementById("filterInput")
          .value.toLowerCase();
        const filterOptions = document.getElementById("filterOptions");

        // Clear existing options and show loading indicator
        filterOptions.innerHTML =
          '<div id="filterLoadingIndicator" class="text-white text-center py-4">Loading filters...</div>';

        try {
          const dynamicFacets = await getDynamicFacets();
          const facetLabels = getFacetLabels();

          console.log("dynamicFacets 2", dynamicFacets);
          console.log("facetLabels 2", facetLabels);

          // Clear loading indicator
          filterOptions.innerHTML = "";

          Object.entries(dynamicFacets).forEach(([facetName, facetValues]) => {
            const facetLabel = facetLabels[facetName] || facetName;
            const facetContainer = document.createElement("div");
            facetContainer.className = "filter-category";
            facetContainer.innerHTML = `
      <div class="filter-category-header">
        <h4 class="font-semibold">${facetLabel}</h4>
        <svg class="chevron w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
      <div class="filter-category-content">
        <div id="${facetName}Options" class="space-y-1 mt-2"></div>
      </div>
    `;
            filterOptions.appendChild(facetContainer);

            const optionsContainer = facetContainer.querySelector(
              `#${facetName}Options`
            );
            const filteredOptions = Object.fromEntries(
              Object.entries(facetValues).filter(
                ([option]) =>
                  option.toLowerCase().includes(inputValue) ||
                  (facetLabels[facetName] &&
                    facetLabels[facetName][option] &&
                    facetLabels[facetName][option]
                      .toLowerCase()
                      .includes(inputValue))
              )
            );
            populateOptions(
              optionsContainer,
              facetName,
              filteredOptions,
              facetLabels[facetName] || {}
            );

            // Add click event for expanding/collapsing
            const header = facetContainer.querySelector(
              ".filter-category-header"
            );
            const content = facetContainer.querySelector(
              ".filter-category-content"
            );
            const chevron = facetContainer.querySelector(".chevron");
            header.addEventListener("click", () => {
              content.classList.toggle("expanded");
              chevron.classList.toggle("rotated");
            });
          });

          // Add price range inputs
          const priceContainer = document.createElement("div");
          priceContainer.className = "filter-category";
          priceContainer.innerHTML = `
          <div class="filter-category-header">
            <h4 class="font-semibold">Price</h4>
            <svg class="chevron w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
          <div class="filter-category-content">
            <div id="priceOptions" class="space-y-1 mt-2">
              <label class="block">
                <input type="number" placeholder="Min" class="w-full p-1 bg-gray-700 border border-gray-600 rounded">
              </label>
              <label class="block mt-2">
                <input type="number" placeholder="Max" class="w-full p-1 bg-gray-700 border border-gray-600 rounded">
              </label>
            </div>
          </div>
        `;
          filterOptions.appendChild(priceContainer);

          // Add click event for expanding/collapsing price
          const priceHeader = priceContainer.querySelector(
            ".filter-category-header"
          );
          const priceContent = priceContainer.querySelector(
            ".filter-category-content"
          );
          const priceChevron = priceContainer.querySelector(".chevron");
          priceHeader.addEventListener("click", () => {
            priceContent.classList.toggle("expanded");
            priceChevron.classList.toggle("rotated");
          });
        } catch (error) {
          console.error("Error loading filters:", error);
          filterOptions.innerHTML =
            '<div class="text-white text-center py-4">Error loading filters. Please try again.</div>';
        }
      }

      // Update the existing populateOptions function
      function populateOptions(container, facetName, options, labels) {
        container.innerHTML = Object.entries(options)
          .map(([option, count]) => {
            const label = labels[option] || option;
            return `
            <label class="block">
              <input type="checkbox" value="${option}" data-label="${label}" class="mr-2">
              ${label} (${count})
            </label>
          `;
          })
          .join("");
      }

      async function openFilterModal() {
        document.getElementById("filterModal").classList.remove("hidden");
        await updateFilterOptions();
      }

      function closeFilterModal() {
        document.getElementById("filterModal").classList.add("hidden");
        document.getElementById("filterInput").value = "";
      }

      async function searchProducts() {
        const searchInput = document.getElementById("searchInput");
        const results = document.getElementById("results");
        const chatMessages = document.getElementById("chatMessages");
        const loadingIndicator = document.getElementById("loadingIndicator");
        const chatSection = document.getElementById("chatSection");

        const searchTerm = searchInput.value.trim();
        if (searchTerm === "") {
          results.innerHTML = "";
          chatMessages.innerHTML = "";
          return;
        }

        // Show loading indicator
        loadingIndicator.classList.remove("hidden");

        // Display skeleton loading
        results.innerHTML = Array(20)
          .fill()
          .map(
            () => `
        <div class="bg-gray-800 animate-pulse">
            <div class="w-full h-48 bg-gray-700 mb-2"></div>
            <div class="h-4 bg-gray-700 w-3/4 mb-2"></div>
            <div class="h-4 bg-gray-700 w-1/2"></div>
        </div>
      `
          )
          .join("");

        if (window.innerWidth > 768) {
          showChatPanel();
          showChatMessages();
          results.classList.remove("w-full");
          results.classList.add("w-4/5");
        } else {
          results.classList.remove("w-4/5");
          results.classList.add("w-full");
          hideChatPanel();
        }
        showFollowUpContainer();

        try {
          const searchOptions = {};
          if (currentFilter) {
            Object.entries(currentFilter).forEach(([facet, values]) => {
              if (facet === "price") {
                if (values.min) searchOptions.minPrice = Number(values.min);
                if (values.max) searchOptions.maxPrice = Number(values.max);
              } else {
                searchOptions[facet] = values;
              }
            });
          }
          console.log("searchOptions", searchOptions);
          const searchResult = await window.gsSDK.search(searchTerm, {
            filter: searchOptions,
          });
          const products = searchResult.hits;
          window.gsSearchState = {
            searchTerm: searchTerm,
            searchOptions: searchOptions,
            productsIds: products.map((product) => product.id),
            searchId: searchResult.searchId,
          };
          displayResults(products);
          displayChatResponse(searchTerm);
        } catch (error) {
          console.error("Error fetching products:", error);
          results.innerHTML =
            '<p class="text-white">Error loading products. Please try again.</p>';
        } finally {
          loadingIndicator.classList.add("hidden");
        }
      }

      function displayResults(products) {
        const results = document.getElementById("results");

        if (products.length > 0) {
          results.innerHTML = products
            .slice(0, 20)
            .map(
              (product) => `
          <div class="bg-transparent text-white">
              <img src="${product.imgs[0].url}" alt="${product.name}" class="w-full h-48 object-cover mb-2">
              <h3 class="font-bold">${product.name}</h3>
              <p>${product.price}</p>
          </div>
        `
            )
            .join("");
        } else {
          results.innerHTML = '<p class="text-white">No products found.</p>';
        }
      }

      function displayChatResponse(query) {
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.innerHTML = ""; // Clear previous messages
        const response =
          getDeviceType() == "desktop"
            ? `Aquí tienes algunos resultados para "${query}". ¿Hay algo específico que te gustaría saber sobre estos productos?`
            : "";
        const messageElement = document.createElement("div");
        messageElement.className = "mb-2";
        messageElement.innerHTML = `
        <p class="font-bold">Assistant:</p>
        <p>${response}</p>
      `;
        chatMessages.appendChild(messageElement);
      }

      function showFollowUpInput() {
        const followUpBtn = document.getElementById("followUpBtn");
        const followUpInputContainer = document.getElementById(
          "followUpInputContainer"
        );
        followUpBtn.classList.add("hidden");
        followUpInputContainer.classList.remove("hidden");
        document.getElementById("followUpInput").focus();
      }

      function hideFollowUpInput() {
        const followUpBtn = document.getElementById("followUpBtn");
        const followUpInputContainer = document.getElementById(
          "followUpInputContainer"
        );
        followUpBtn.classList.remove("hidden");
        followUpInputContainer.classList.add("hidden");
      }

      async function handleFollowUp() {
        const followUpInput = document.getElementById("followUpInput");
        const chatMessages = document.getElementById("chatMessages");
        const followUpQuery = followUpInput.value.trim();
        if (followUpQuery) {
          showChatMessages();
          showChatPanel();

          const userMessageElement = document.createElement("div");
          userMessageElement.className = "mb-2";
          userMessageElement.innerHTML = `
                <p class="font-bold">You:</p>
                <p>${followUpQuery}</p>
              `;
          chatMessages.appendChild(userMessageElement);

          const payload = {
            referenceId: window.gsSearchState.searchId,
            html: true,
            input: window.gsSearchState.searchTerm,
            productIds: window.gsSearchState.productsIds,
            deviceType: getDeviceType(),
            currentCart: {},
            country: "Uruguay",
            userQuestion: followUpQuery,
          };

          showLoading();
          try {
            const aiResponse = await window.gsSDK.searchChat(payload);
            console.log("aiResponse", aiResponse);
            const aiMessageElement = document.createElement("div");
            aiMessageElement.className = "mb-2";
            aiMessageElement.innerHTML = `
                  <p class="font-bold">Assistant:</p>
                  ${aiResponse.response}
                `;
            chatMessages.appendChild(aiMessageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            followUpInput.value = "";
            hideLoading();
          } catch (e) {
            console.log("error", e);
            hideLoading();
          }
        }
      }

      // Close autocomplete when clicking outside
      document.addEventListener("click", function (e) {
        if (
          e.target.id !== "searchInput" &&
          e.target.parentNode.id !== "autocomplete-list"
        ) {
          hideAutocomplete();
        }
      });

      // Add a window resize event listener to handle layout changes
      window.addEventListener("resize", () => {
        const results = document.getElementById("results");
        const chatSection = document.getElementById("chatSection");
        const chatMessages = document.getElementById("chatMessages");

        if (window.innerWidth > 768) {
          showChatPanel();
          showChatMessages();
          results.classList.remove("w-full");
          results.classList.add("w-4/5");
        } else {
          if (chatMessages.innerHTML.trim() === "") {
            hideChatMessages();
          }
          results.classList.remove("w-4/5");
          results.classList.add("w-full");
        }
      });

      function getDeviceType() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
          navigator.userAgent
        )
          ? "mobile"
          : "desktop";
      }
    </script>
  </body>
</html>
